name: DÃ©ploiement de la stack de monitoring

on:
  workflow_dispatch:

jobs:
  deploy:
    name: ðŸš€ DÃ©ploiement du monitoring
    runs-on: self-hosted

    steps:
      - name: ðŸ§¾ RÃ©cupÃ©rer le dÃ©pÃ´t
        uses: actions/checkout@v4

      - name: ðŸ“¥ Installer Helm
        uses: azure/setup-helm@v3

      - name: ðŸ“¦ Ajouter le dÃ©pÃ´t Helm du NFS Provisioner
        run: |
          helm repo add nfs-subdir-external-provisioner https://kubernetes-sigs.github.io/nfs-subdir-external-provisioner
          helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
          helm repo update

      - name: ðŸš€ DÃ©ployer le NFS Provisioner
        run: |
          helm upgrade --install nfs-subdir-external-provisioner \
            nfs-subdir-external-provisioner/nfs-subdir-external-provisioner \
            --namespace kube-system --create-namespace \
            --set nfs.server=10.42.0.1 \
            --set nfs.path=/srv/nfs/kubedata \
            --set storageClass.name=nfs-storage \
            --set storageClass.defaultClass=true
        env:
          KUBECONFIG: /root/.kube/config

      - name: ðŸ“‹ VÃ©rifier la crÃ©ation de la StorageClass
        run: kubectl get storageclass
        env:
          KUBECONFIG: /root/.kube/config

      - name: ðŸ“Š DÃ©ployer kube-prometheus-stack
        run: |
          helm upgrade --install monitoring prometheus-community/kube-prometheus-stack \
            --namespace monitoring --create-namespace \
            -f monitoring/helm-values/kube-prometheus-stack-values.yaml
        env:
          KUBECONFIG: /root/.kube/config
